#!/usr/bin/env python

from contextlib import contextmanager
import time
import os
import subprocess
import re
import phatbeat
from mpd import MPDClient

class SimpleClient:
    def __init__(self):
        self.mpd_client = None

    @contextmanager
    def connection(self):
        try:
            self.client.connect("localhost", 6600)
            yield
        finally:
            self.client.close()
            self.client.disconnect()

    @property
    def client(self):
        if self.mpd_client == None:
            mpd_client = MPDClient()
            mpd_client.timeout = 10
            self.mpd_client = mpd_client
        return self.mpd_client

    def status(self, property):
        with self.connection():
            try:
                return self.client.status()[property]
            except:
                return None

    def volume(self, change=0):
        print('volume!')
        with self.connection():
            try:
                print('volume?')
                new_volume = min(35, int(self.status('volume')) + change)
                self.client.setvol(new_volume)
                return new_volume
            except:
                return 0

    @property
    def is_playing(self):
        with self.connection():
            try:
                return self.status('state') == 'play'
            except:
                return None

    def play_pause(self):
        with self.connection():
            try:
                if not self.client.playlist():
                    print('load "default" playlist')
                    self.client.load('default')
                if self.is_playing:
                    print('pause')
                    self.client.stop()
                else:
                    print('play')
                    self.client.play()
            except:
                return None

class Pixel:
    def __init__(self, id):
        self.id = id
        default = {
            'r': 0,
            'g': 0,
            'b': 0,
            'brightness': 0
        }
        self.default = default
        self.state = default
        self.velocity = default
        self.clock = time.time()

    def clear(self):
        self.set(self.default, self.default)

    def set(self, state, velocity=None):
        self.state = state
        if velocity == None:
            velocity = self.default
        self.velocity = velocity
        self.clock = time.time()

    def render(self):
        state = self.state
        phatbeat.set_pixel(self.id, state['r'], state['g'], state['b'], state['brightness'])

    def loop(self):
        delta = time.time() - self.clock
        new_state = {
            'r': min(255, max(0, self.state['r'] + self.velocity['r'] * delta)),
            'g': min(255, max(0, self.state['g'] + self.velocity['g'] * delta)),
            'b': min(255, max(0, self.state['b'] + self.velocity['b'] * delta)),
            'brightness': min(1, max(0, self.state['brightness'] + self.velocity['brightness'] * delta))
        }
        self.state = new_state
        self.clock = time.time()

class VU:
    def __init__(self):
        self.pixels = list(map(lambda x: Pixel(x), range(0, 16)))

    def loop(self):
        for pixel in self.pixels:
            pixel.loop()

    def render(self):
        for pixel in self.pixels:
            pixel.render()

    def blink(self):
        self.pixels[0].set({
            'r': 200,
            'g': 200,
            'b': 200,
            'brightness': 0.25
        }, {
            'r': 0,
            'g': 0,
            'b': 0,
            'brightness': -0.5
        })

    def flash(self):
        for pixel in self.pixels:
            pixel.set({
                'r': 200,
                'g': 200,
                'b': 200,
                'brightness': 0.25
            }, {
                'r': 0,
                'g': 0,
                'b': 0,
                'brightness': -0.5
            })

    def bar(self, value, max_value):
        last_command_time = time.time()
        level = min(7, int(round(7*(float(value)/max_value))))
        green = {
            'r': 50,
            'g': 200,
            'b': 50,
            'brightness': 0.25
        }
        velocity = {
            'r': 0,
            'g': 0,
            'b': 0,
            'brightness': -0.5
        }
        for x in range(0, 8):
            if(x < level):
                self.pixels[7 - x].set(green, velocity)
                self.pixels[x + 8].set(green, velocity)
            else:
                self.pixels[7 - x].clear()
                self.pixels[x + 8].clear()

if __name__ == "__main__":
    client = SimpleClient()
    vu = VU()
    vu.flash()

    @phatbeat.on(phatbeat.BTN_VOLUP)
    def volume_up(pin):
        print(client.volume(+3))
        vu.bar(client.volume(), 35)

    @phatbeat.on(phatbeat.BTN_VOLDN)
    def volume_down(pin):
        print(client.volume(-3))
        vu.bar(client.volume(), 35)

    @phatbeat.on(phatbeat.BTN_PLAYPAUSE)
    def play_pause(pin):
        print(client.play_pause())

    try:
        while True:
            vu.loop()
            vu.render()
            phatbeat.show()
            time.sleep(1/24.0)

    except KeyboardInterrupt:
        pass
